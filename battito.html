<meta charset="UTF-8"><meta name="viewport" content="width=device-width"><script> onload=()=>{

document.title="Battito";//https://github.com/bacionejs/battito

let audio,SC=8,SR=60,PC=48,PR=32;
let LT=0,TB=0,PS=0;
//LT LastTrack - supports adding track while others are playing
//TB TimeBased,PS PatternStart - support timebased input vs stepbased. PS supports - On the first interaction each loop, the pattern clears, because timebased (improv?) input is messy...otherwise there would need to be separate buttons like clear-pattern.
let piano      =element("div",document.body,"piano");
let message    =element("div",piano,"message");
let sliders    =element("div",document.body,"sliders");
let side       =element("div",document.body,"side");
let sequencer  =element("div",side,"sequencer");
let text       =element("textarea",side,"text");
let canvas     =element("canvas",side,"canvas");
let fullscreen =element("div",side,"fullscreen");
let loading    =element("div",side,"loading");

(function main(){
if(navigator.userAgent.includes("Firefox"))return document.body.innerHTML="Tested on Android Chrome";
initErrorHandler();
initStyle();
initAudio();
initPiano();
initSequencer();
initSliders();
initText();
initListeners();
tutorial();
})();











function initPiano(){
grid(piano,PC,PR);
line(piano,PC,"x",12);
line(piano,PC,"y",4);
}

function initSequencer(){
grid(sequencer,SC,SR,true);
for(let i=0;i<8;i++){element("div",sequencer.cells[0],"meter");}
for(let i=1;i<SC+1;i++){sequencer.cells[i].textContent=String.fromCharCode(64+i);sequencer.cells[i].style.color=getColor(i-1);}
for(let i=SC+1;i<(SC+1)*(SR+1);i+=SC+1){sequencer.cells[i].textContent=i/(SC+1);}
initSequencerHelpers();
}

function initSliders(){
SLIDERS().forEach((group,i)=>{
  group.forEach(([label,key,max])=>{
    let l=element("label",sliders);l.textContent=label;l.style.color=getColor(i);
    let s=element("input",sliders,"slider");
    s.type="range";s.key=key;s.max=max;s.disabled=true;
  });
});
}

function initText(){updateText();}










function updatePiano(){
piano.forEach(cell=>{cell.style.background="";});
sequencer.cols.forEach((on,tid)=>{if(!on)return;
  let t=audio.song.tracks[tid];
//   t?.c?.[t?.p[audio.currs]-1]?.n?.forEach((note,step)=>{
  t?.p?.[t?.s[audio.currs]-1]?.forEach((note,step)=>{
    if(note && note>=123 && note<=123+PC){piano.cells[step*PC+note-123].style.background=getColor(tid);}
  });
});
}

function updateSequencer(){
sequencer.forEach(cell=>{
  cell.classList.remove("active","row-selected","col-selected");
  let {row,col}=cell;
  if(row===-1 && col===-1){return;}
  if(row===-1){
    if(sequencer.cols[col])cell.classList.add("col-selected");
  }else if(col===-1){
    if(sequencer.rows[row])cell.classList.add("row-selected");
  }else{
    cell.textContent="";
    let r=row,c=col,t=audio.song.tracks[c];
    if(t?.s?.[r]!==undefined){
      if(sequencer.rows[r] && sequencer.cols[c]){cell.classList.add("active");}
      cell.textContent=t.s[r]||"";
    }
  }
});
}

function updateSliders(){
let ss=sliders.querySelectorAll(".slider");
let t=sequencer.track();
if(t!==null){
  ss.forEach(s=>{s.disabled=false;s.value=t[s.key]||0;});
}else{
  ss.forEach(s=>{s.disabled=true; s.value=0;});
}
}

function updateText(){let s=text.selectionStart;text.value=JSON.stringify(audio.song,null,2);text.setSelectionRange(s,s);}











function initListeners(){
piano      .onclick=handlePianoClick;
sequencer  .onclick=handleSequencerClick;
sliders    .oninput=handleSliderInput;
text       .oninput=handleSongInput;
fullscreen .onclick=document.documentElement.requestFullscreen.bind(document.documentElement);
makeLongPress(canvas,audio.download);
makeLongPress(piano,()=>{message.textContent=(TB^=1)?"timemode":"stepmode";message.classList.remove("show");message.offsetWidth;message.classList.add("show");});
[piano,sequencer,sliders].forEach(el=>{el.addEventListener('contextmenu',e=>e.preventDefault());});
}

function handlePianoClick({target:{row,col}}){
let p=sequencer.pattern();
if(p==null){
  let note=col+123;
  audio.preview(note);
  return;
}
if(TB){
  if(PS==0){PS=1;for(let i=0;i<p.length;i++){p[i]=0;}}//On the first interaction each loop, the pattern clears.
  let note=col+123;
  let r=audio.currp;//timebased
  if(p[r]==note){p[r]=0;update();return;}
  p[r]=note;
  update();
  audio.preview(note);
}else{
  let note=col+123;
  let r=row;//stepbased
  if(p[r]==note){p[r]=0;update();return;}
  p[r]=note;
  update();
  audio.preview(note);
}
}

function handleSequencerClick({target}){sequencer.click(target);update();audio.start();}

function handleSliderInput(e){
if(!e.target.classList.contains("slider"))return;
let t=sequencer.track();if(t==null)return;
t[e.target.key]=+e.target.value;
update();audio.preview();
}

function handleSongInput(){try{
let song=JSON.parse(text.value);audio.song=song;
updatePiano();updateSliders();updateSequencer();audio.preview();
}catch(e){}}

function update(){updatePiano();updateSliders();updateSequencer();updateText();}











function grid(e,cols,rows,header){
let cells=[],a=0;if(header){a=-1;cols++;rows++;}
Object.assign(e.style,{gridTemplateColumns:"repeat("+cols+",1fr)",gridTemplateRows:"repeat("+rows+",1fr)"});
for(let i=0;i<cols*rows;i++){
  let c=i%cols,r=Math.floor(i/cols),classes="cell";
  if(header===true){if(r===0){classes+=" col-header";}if(c===0){classes+=" row-header";}}
  let cell=element("div",e,classes);
  cell.row=r+a;cell.col=c+a;
  cells.push(cell);
}
e.forEach=f=>cells.forEach(f);
e.cells=cells;
}

function line(e,width,dir,freq){
let [rule,side]=dir=="x"?[i=>!(i%width%freq),"Left"]:[i=>!((i/width|0)%freq),"Top"];
e.forEach((cell,i)=>{rule(i)&&(cell.style["border"+side+"Color"]="black");});
}

function makeLongPress(o,callback){
let t=null,lp={
  down(e){e.preventDefault();if(t!==null){clearTimeout(t);}t=setTimeout(()=>{t=null;callback(e);},800);},
  up  (e){e.preventDefault();if(t!==null){clearTimeout(t);t=null;}}
};
o.addEventListener("pointerdown",lp.down);o.addEventListener("pointerup",lp.up);o.addEventListener("pointerleave",lp.up);
}

function initErrorHandler(){addEventListener("error",e=>{
let s="Error: "+e.message+"\nFile: "+e.filename+"\nLine: "+e.lineno+":"+e.colno;if(e.error)s+="\nName: "+e.error.name+"\nStack:\n"+e.error.stack;
prompt("Error",s);
});}

function element(tag,parent=document.body,c=""){let e=parent.appendChild(document.createElement(tag));if(c)e.className=c;return e;}

function getColor(i){let hue=((i+5)*360)/9;return "hsl("+hue+",70%,50%)";}











function initSequencerHelpers(){
let cols=Array(SC).fill(0),rows=Array(SR).fill(0);
let bars=[...sequencer.cells[0].children];

function click({row,col}){
if(row===-1&& col===-1)toggleAll();
else if(row===-1){cols[col]=cols[col]?0:1;audio.preview();LT=col;}
else if(col===-1){rows[row]=rows[row]?0:1;}
else cell(row,col);
}

function toggleAll(){
let i,mr=0,mc=0,all=true;
audio.song.tracks.forEach((t,c)=>{t.s.forEach((v,r)=>{if(v){if(c>mc)mc=c;if(r>mr)mr=r;}});});
for(i=0;i<=mr;i++)if(!rows[i])all=false;
for(i=0;i<=mc;i++)if(!cols[i])all=false;
for(i=0;i<rows.length;i++)rows[i]=(i<=mr)?(all?0:1):0;
for(i=0;i<cols.length;i++)cols[i]=(i<=mc)?(all?0:1):0;
}

function cell(row,col){
let r=row,c=col,t=audio.song.tracks[c],i=t.s[r]??0;
// t.s[r]=(i+1)%10;if(t.s[r]>t.p.length){t.p.push({n:Array(PR).fill(0)});}
t.s[r]=(i+1)%10;if(t.s[r]>t.p.length){t.p.push(Array(PR).fill(0));}
}

function range(song){
if(!(rows.some(Boolean) && cols.some(Boolean)))return null;
let d=structuredClone(song.tracks).filter((_,c)=>cols[c]);if(!d.length)return null;
d.forEach(t=>rows.forEach((on,r)=>{if(!on||!t.s[r])t.s[r]=0;}));
for(let r=rows.length-1;r>=0;r--)if(!d.some(t=>t.s[r]))d.forEach(t=>t.s.splice(r,1));if(!d[0].s.length)return null;
if(!d.some(t=>t.s.some(Boolean)))return null;
// return {bpm:song.bpm,endPattern:d[0].s.length,tracks:d};
return {bpm:song.bpm,tracks:d};
}

function hasNotes(song){
let r=range(song);if(!r)return null;
// return r.tracks.some(t=>t.p.some(p=>p>0 && t.c[p-1]?.n.some(Boolean)))?r:null;
return r.tracks.some(t=>t.s.some(p=>p>0 && t.p[p-1]?.some(Boolean)))?r:null;
}

function sequences(){
return rows.reduce((acc,on,r)=>{
  if(!on)return acc;
  for(let t of audio.song.tracks){if(t.s[r]){acc.push(r);break;}}
  return acc;
},[]);
}

function track(){
if(cols.filter(Boolean).length!=1){return audio.song.tracks[LT];}//supports adding track while others playing
return audio.song.tracks[cols.indexOf(1)]||null;
}

function pattern(){
let t=track();if(!t)return null;
if(rows.filter(Boolean).length!=1)return null;
let i=rows.indexOf(1);if(!t?.s?.[i])return null;
// return (t.c[t.p[i]-1]||(t.c[t.p[i]-1]={n:Array(PR).fill(0)})).n;
return t.p[t.s[i]-1]||(t.p[t.s[i]-1]=Array(PR).fill(0));
}

function scroll(curr){
if(curr==0)sequencer.scrollTop=0;
let c=sequencer.cells[(curr+1)*(SC+1)],h=sequencer.cells[0].offsetHeight,t=c.offsetTop-sequencer.offsetTop,b=t+c.offsetHeight;
let v1=sequencer.scrollTop+h,v2=sequencer.scrollTop+sequencer.clientHeight;
if(t<v1)sequencer.scrollTop=t-h; else if(b>v2)sequencer.scrollTop=b-sequencer.clientHeight;
}

function spectrum(meter){
if(meter)bars.forEach((b,i,a)=>{b.style.height=(meter[Math.floor(i*(meter.length/a.length))]/255*100)+"%";});
else     bars.forEach(bar=>bar.style.height="0%");
}

Object.assign(sequencer, {cols, rows, click, track, sequences, pattern, range, hasNotes, scroll, spectrum});
}//











function initAudio(){
let C=new AudioContext(),S=null,PLAYER=BattitoPlayer(C),SONG=PRESETS(),sequences,raf,currS,prevS,currP,prevP;
let analyser=C.createAnalyser();analyser.fftSize=32;let meter=new Uint8Array(analyser.frequencyBinCount);

function start(){
stop();
sequences=sequencer.sequences();if(sequences.length===0)return;
let json=sequencer.range(SONG);if(!json)return;
loading.style.display="block";
requestAnimationFrame(()=>requestAnimationFrame(()=>{
S=C.createBufferSource();S.buffer=PLAYER.createbuffer(json);loading.style.display="none";
S.connect(analyser);analyser.connect(C.destination);
S.onended=()=>{start();};
let startTime=C.currentTime;S.start(startTime);S.startTime=startTime;
raf=requestAnimationFrame(loop);
}));
}

function stop(){
if(raf){cancelAnimationFrame(raf);raf=null;}
if(S){S.onended=null;S.stop();S.disconnect();S=null;}
sequencer.spectrum(false);
}

function loop(){
if(!S?.buffer)return;
analyser.getByteFrequencyData(meter);sequencer.spectrum(meter);
let t=(C.currentTime-S.startTime)*SONG.bpm/PR/15;
if(t>=sequences.length){if(raf)cancelAnimationFrame(raf);return;}
currS=sequences[t|0];
currP=(t*PR|0)%PR;
if(currS!==prevS){point(sequencer,SC,prevS,currS,1);prevS=currS;sequencer.scroll(currS);updatePiano();}
if(currP!==prevP){point(piano    ,PC,prevP,currP  );prevP=currP;if(currP==0)PS=0;}
raf=requestAnimationFrame(loop);
}

function point(grid,width,prev,curr,o=0){[[prev,"remove"],[curr,"add"]].forEach(([x,m])=>grid.cells[(x+o)*(width+o)]?.classList[m]("row-playing"));}

function preview(note){
let playing=null;
let base=new Array(PR).fill(0);
preview=function(note){
  if(playing){playing.stop();playing=null;}
  let t=sequencer.track();if(t==null)return;
//   base[0]=note||t?.c[0]?.n?.find(n=>n!==0)||147;
  base[0]=note||t?.p[0]?.find(n=>n!==0)||147;
//   let song={bpm:SONG.bpm,endPattern:1,tracks:[{...t,p:[1],c:[{n:base}]}]};
  let song={bpm:SONG.bpm,tracks:[{...t,s:[1],p:[base]}]};
  let s=Object.assign(C.createBufferSource(),{buffer:PLAYER.createbuffer(song)});s.onended=()=>{if(playing===s){playing=null;}};s.connect(C.destination);s.start();playing=s;
  waveform(s.buffer.getChannelData(0));
};
function waveform(d){
  let c=canvas.getContext("2d"),w=canvas.width,h=canvas.height,m=h/2,p=d.length/w/PR/4;
  c.clearRect(0,0,w,h);c.beginPath();for(let x=0;x<w;x++){c.lineTo(x,m+d[x*p|0]*m);}
  c.lineWidth=2;c.strokeStyle="blue";c.stroke();
}
return preview(note);
}

function download(){try{
if(!sequencer.hasNotes(SONG))return alert("Nothing to save. Please select song or range");
let a=element("a"),file="battito_song_"+Date.now();
a.href=URL.createObjectURL(bufferToWav());a.download=file+".wav";a.click();
a.href=URL.createObjectURL(new File([jsonToHtml()],""));a.download=file+".html";a.click();
URL.revokeObjectURL(a.href);a.remove();
}catch(e){alert(e.message);}
function jsonToHtml(){
  let s="";
  s+="\n<\script>onload=()=>{addEventListener('click',play);document.body.textContent='Click to play'";
  s+="\nlet json="+JSON.stringify(sequencer.range(SONG));
  s+="\nlet C=new AudioContext(),buffer=BattitoPlayer(C).createbuffer(json)";
  s+="\nfunction play(){let S=C.createBufferSource();S.buffer=buffer;S.connect(C.destination);S.start();}//to loop: S.loop=true";
  s+="\n"+BattitoPlayer;
  s+="\n}</\script>";
  return s;
}
function bufferToWav(){
  let b=S.buffer,c=b.numberOfChannels,l=b.length*c*2+44,o=new ArrayBuffer(l),v=new DataView(o),a=[],p=0,f=x=>{v.setUint16(p,x,1);p+=2;},F=x=>{v.setUint32(p,x,1);p+=4;};
  F(0x46464952);F(l-8);F(0x45564157);F(0x20746d66);F(16);f(1);f(c);F(b.sampleRate);F(b.sampleRate*c*2);f(c*2);f(16);F(0x61746164);F(l-p-4);
  for(let i=0;i<c;i++)a.push(b.getChannelData(i));
  for(let i=0,j=0;p<l;j++)for(i=0;i<c;i++){let s=a[i][j];s=s<-1?-1:s>1?1:s;s=(s<0?s*32768:s*32767)|0;v.setInt16(p,s,1);p+=2;}
  return new Blob([o],{type:"audio/wav"});
}
}

audio={stop,start,preview,download,get song(){return SONG;},set song(newSong){SONG=newSong;},get currp(){return currP;},get currs(){return currS;}};
}//











function initStyle(){element("style").textContent=`
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:none;user-select:none;touch-action:manipulation;}
body{display:flex;background:black;color:white;font-weight:bold;font-family:monospace;}
@keyframes fade{0%{opacity:0;}50%{opacity:1;}100%{opacity:0;}}
.message{color:silver;font-size:5rem;top:50%;left:50%;translate:-50% -50%;position:absolute;z-index:2;pointer-events:none;opacity:0;}
.message.show{animation:fade 2s ease forwards;}
.piano{position:relative;}
.piano, .sequencer{display:grid;}
.side{background:black;}
.piano{background:white;}
.sliders{display:flex;flex-direction:column;justify-content:space-evenly;font-size:8px;}
.sliders > * {display:flex;flex-direction:column;align-items:center;}
.sliders .slider{height:2px;}
.sliders input[type="range"]::-webkit-slider-thumb{opacity:0;}
.sequencer{height:50%;aspect-ratio:1/1;overflow-y:scroll;background:black;}
.sequencer > :first-child{display:grid;grid-auto-flow:column;place-items:end stretch;}
.meter{pointer-events:none;background:linear-gradient(to top,lime,orange,red);transition:height 50ms linear;}
.col-header{position:sticky;top:0;background:black;z-index:1;}
.cell{display:grid;place-items:center;border:1px solid silver;aspect-ratio:1/1;}
.col-selected, .row-selected{background:gray !important;}
.row-playing{border-left:3px solid orange !important;}
.active{background:blue;}
.text{padding:10px;font-size:8px;white-space:pre;overflow:auto;background:transparent;color:white;outline:none;}
.text, .canvas{height:25%;aspect-ratio:2/1;border:1px solid silver;border-top:none;}
.fullscreen::before{content:"â›¶"}
:fullscreen .fullscreen{display:none;}
.fullscreen, .loading{line-height:0;position:relative;bottom:1rem;z-index:1;}
.fullscreen{font-size:1rem;  text-align:right ;color:orange;right:0.5rem;}
.loading   {font-size:0.3rem;text-align:center;color:silver;display:none;}
.loading::before{content:"loading..."}
`;
}











function SLIDERS(){return [
[["1v","osc1_vol",255],["1w","osc1_waveform",3],["1o","osc1_oct",16],["1s","osc1_det",11],["1d","osc1_detune",255]],
[["2v","osc2_vol",255],["2w","osc2_waveform",3],["2o","osc2_oct",16],["2s","osc2_det",11],["2d","osc2_detune",255]],
[["ea","env_attack",200000],["es","env_sustain",200000],["er","env_release",200000],["e1","osc1_xenv",1],["e2","osc2_xenv",1]],
[["ct","fx_filter",4],["ca","fx_freq",11025],["cr","fx_resonance",255]],
[["mw","lfo_waveform",3],["ms","lfo_freq",16],["ma","lfo_amt",255],["m1","lfo_osc1_freq",1],["mc","lfo_fx_freq",1]],
[["ds","fx_delay_time",16],["da","fx_delay_amt",248],["ps","fx_pan_freq",16],["pa","fx_pan_amt",255]],
[["nv","noise_fader",255],["vm","env_master",255]],
];}

function PRESETS(){return {"bpm":120,"tracks":[
{"osc1_oct":9,"osc1_det":0,"osc1_detune":0,"osc1_xenv":1,"osc1_vol":255,"osc1_waveform":0,"osc2_oct":7,"osc2_det":0,"osc2_detune":0,"osc2_xenv":1,"osc2_vol":255,"osc2_waveform":0,"noise_fader":0,"env_attack":100,"env_sustain":0,"env_release":5970,"env_master":171,"fx_filter":2,"fx_freq":500,"fx_resonance":254,"fx_delay_time":1,"fx_delay_amt":31,"fx_pan_freq":4,"fx_pan_amt":21,"lfo_osc1_freq":0,"lfo_fx_freq":0,"lfo_freq":0,"lfo_amt":0,"lfo_waveform":0,
"s":[],"p":[]},
// "s":[1,1,1,1],"p":[[123,0,0,0,123,0,0,0,123,0,0,0,123,0,0,0,123,0,0,0,123,0,0,0,123,0,0,0,123,0,0,0]]},
{"osc1_oct":6,"osc1_det":11,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":255,"osc1_waveform":2,"osc2_oct":6,"osc2_det":11,"osc2_detune":4,"osc2_xenv":0,"osc2_vol":255,"osc2_waveform":2,"noise_fader":0,"env_attack":88,"env_sustain":2000,"env_release":7505,"env_master":255,"fx_filter":2,"fx_freq":3144,"fx_resonance":51,"fx_delay_time":6,"fx_delay_amt":60,"fx_pan_freq":4,"fx_pan_amt":64,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":7,"lfo_amt":179,"lfo_waveform":0,
"s":[],"p":[]},
// "s":[1,1,1,1],"p":[[0,0,124,0,0,0,0,0,0,0,0,0,0,0,124,0,124,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},
{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":192,"osc1_waveform":2,"osc2_oct":7,"osc2_det":0,"osc2_detune":0,"osc2_xenv":0,"osc2_vol":201,"osc2_waveform":3,"noise_fader":0,"env_attack":100,"env_sustain":150,"env_release":7505,"env_master":191,"fx_filter":2,"fx_freq":5839,"fx_resonance":254,"fx_delay_time":6,"fx_delay_amt":121,"fx_pan_freq":6,"fx_pan_amt":147,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":6,"lfo_amt":195,"lfo_waveform":0,
"s":[],"p":[]},
// "s":[1,1,2,3],"p":[ [135,0,0,0,0,0,0,0,159,0,157,0,159,0,0,0,0,0,0,0,0,0,0,0,147,154,0,159,0,0,0,0], [138,0,0,0,0,0,0,0,150,0,159,0,162,0,0,0,0,0,0,0,0,0,150,0,162,150,0,159,0,0,0,0], [149,0,0,0,0,0,0,0,149,0,150,0,154,0,0,0,0,0,0,0,0,0,0,0,147,157,0,159,0,0,0,0] ]},
{"osc1_oct":9,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":255,"osc1_waveform":0,"osc2_oct":9,"osc2_det":0,"osc2_detune":12,"osc2_xenv":0,"osc2_vol":255,"osc2_waveform":0,"noise_fader":0,"env_attack":100,"env_sustain":0,"env_release":14545,"env_master":70,"fx_filter":0,"fx_freq":0,"fx_resonance":240,"fx_delay_time":2,"fx_delay_amt":157,"fx_pan_freq":3,"fx_pan_amt":47,"lfo_osc1_freq":0,"lfo_fx_freq":0,"lfo_freq":0,"lfo_amt":0,"lfo_waveform":0,"s":[],"p":[]},
{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":255,"osc1_waveform":3,"osc2_oct":8,"osc2_det":0,"osc2_detune":0,"osc2_xenv":0,"osc2_vol":255,"osc2_waveform":0,"noise_fader":127,"env_attack":22,"env_sustain":22,"env_release":2193,"env_master":255,"fx_filter":3,"fx_freq":4067,"fx_resonance":176,"fx_delay_time":4,"fx_delay_amt":12,"fx_pan_freq":2,"fx_pan_amt":84,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":3,"lfo_amt":96,"lfo_waveform":0,"s":[],"p":[]},
{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":255,"osc1_waveform":2,"osc2_oct":7,"osc2_det":0,"osc2_detune":9,"osc2_xenv":0,"osc2_vol":154,"osc2_waveform":2,"noise_fader":0,"env_attack":2418,"env_sustain":1075,"env_release":10614,"env_master":240,"fx_filter":3,"fx_freq":2962,"fx_resonance":255,"fx_delay_time":6,"fx_delay_amt":117,"fx_pan_freq":3,"fx_pan_amt":73,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":5,"lfo_amt":124,"lfo_waveform":0,"s":[],"p":[]},
{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":192,"osc1_waveform":3,"osc2_oct":7,"osc2_det":0,"osc2_detune":7,"osc2_xenv":0,"osc2_vol":201,"osc2_waveform":3,"noise_fader":0,"env_attack":789,"env_sustain":1234,"env_release":13636,"env_master":191,"fx_filter":2,"fx_freq":5839,"fx_resonance":254,"fx_delay_time":6,"fx_delay_amt":121,"fx_pan_freq":6,"fx_pan_amt":147,"lfo_osc1_freq":0,"lfo_fx_freq":1,"lfo_freq":6,"lfo_amt":195,"lfo_waveform":0,"s":[],"p":[]},
{"osc1_oct":7,"osc1_det":0,"osc1_detune":0,"osc1_xenv":0,"osc1_vol":192,"osc1_waveform":2,"osc2_oct":7,"osc2_det":0,"osc2_detune":0,"osc2_xenv":0,"osc2_vol":192,"osc2_waveform":2,"noise_fader":0,"env_attack":0,"env_sustain":0,"env_release":20000,"env_master":192,"fx_filter":0,"fx_freq":0,"fx_resonance":0,"fx_delay_time":0,"fx_delay_amt":0,"fx_pan_freq":0,"fx_pan_amt":0,"lfo_osc1_freq":0,"lfo_fx_freq":0,"lfo_freq":0,"lfo_amt":0,"lfo_waveform":0,"s":[],"p":[]}
]};}











function BattitoPlayer(audiocontext){
let SIN=new Float32Array(1024);for(let i=0;i<1024;i++)SIN[i]=Math.sin(i*2*Math.PI/1024);let sin=(v)=>SIN[((v*1024)&1023)>>>0];
let Q=new Float32Array(256);for(let n=0;n<256;n++){let f=0.00390625,m=1.059463094,l=128,i=n;if(i>l)i-=l;else{i=l-i;m=1/m;}while(i-->0)f*=m;Q[n]=f;}
let O=(t,v)=>{let p=v-Math.floor(v);switch(t){case 0:return sin(p);case 1:return p<0.5?-1:1;case 2:return p-0.5;case 3:let v2=p*4;return v2<2?v2-1:3-v2;default:return sin(p);}};
let G=(f,m,n,l)=>{if(n>l)n-=l;else{n=l-n;m=1/m;}while(n-->0)f*=m;return f;};
let R_S=1,rnd=()=>{R_S=Math.imul(R_S,0x15a4e35);return (R_S>>>0)%255/255.0;};

let createbuffer=(d)=>{
let rowLen=Math.ceil(15*44100/d.bpm),I=d.tracks;
let E=0;I.forEach(t=>{if(t.s.length>E)E=t.s.length;});
let PR=0;I.forEach(t=>t.p.forEach(p=>{if(p.length>PR)PR=p.length;}));
let T=E*PR*rowLen;
let l=new Float32Array(T),r=new Float32Array(T),L=new Float32Array(T),R=new Float32Array(T);
for(let i=0;i<I.length;i++){
  let B=I[i],P=0,lfo_step=G(1,2,B.lfo_freq,8)/rowLen,pan_step=G(1,2,B.fx_pan_freq,8)/rowLen;L.fill(0);R.fill(0);
  for(let p=0;p<E;p++){
    let C=B.s[p];
    for(let row=0;row<PR;row++){
      let n,osc1_freq_base=0.0,osc2_freq_base=0.0;
//       if(C>0&&(n=B.c[C-1].n[row])>0){
      if(C>0&&(n=B.p[C-1][row])>0){
        osc1_freq_base=Q[n+(B.osc1_oct-8)*12+B.osc1_det]*(1+0.2*B.osc1_detune/255.0);
        osc2_freq_base=Q[n+(B.osc2_oct-8)*12+B.osc2_det]*(1+0.2*B.osc2_detune/255.0);
        let [a,s,r]=[B.env_attack,B.env_sustain,B.env_release];
        let [c1,c2,low,band]=[0,0,0,0],q=B.fx_resonance/255.0;
        let D=a+s+r;
        for(let j=0;j<D;j++){
          let b=j+P;if(b>=T)break;let lfoR,e=1,f,rs,high,t;
          lfoR=O(B.lfo_waveform,lfo_step*b)*(B.lfo_amt/512.0)+0.5;
          if(j<a)e=j/a;else if(j>=a+s)e-=(j-a-s)/r;
          let t1=osc1_freq_base;if(B.lfo_osc1_freq)t1+=lfoR;if(B.osc1_xenv)t1*=e*e;c1+=t1;rs=O(B.osc1_waveform,c1)*(B.osc1_vol/255.0);
          let t2=osc2_freq_base;if(B.osc2_xenv)t2*=e*e;c2+=t2;rs+=O(B.osc2_waveform,c2)*(B.osc2_vol/255.0);
          if(B.noise_fader)rs+=O(0,rnd())*(B.noise_fader/255.0)*e;rs*=e;
          f=B.fx_freq;if(B.lfo_fx_freq)f*=lfoR;f=1.5*(f*Math.PI/44100);
          if(q>0){low+=f*band;high=q*(rs-band)-low;band+=f*high;switch(B.fx_filter){case 1:rs=high;break;case 2:rs=low;break;case 3:rs=band;break;case 4:rs=low+high;break;}}
          t=O(0,pan_step*b)*(B.fx_pan_amt/512.0)+0.5;rs*=B.env_master*0.006;L[b]+=rs*(1-t);R[b]+=rs*t;
        }
      }
      P+=rowLen;
    }
  }
  let D_S=Math.floor(B.fx_delay_time*rowLen/2);if(D_S>0){let D_A=B.fx_delay_amt/255.0;for(let b=0;b<T-D_S;b++){L[b+D_S]+=R[b]*D_A;R[b+D_S]+=L[b]*D_A;}}
  for(let b=0;b<T;b++){l[b]+=L[b];r[b]+=R[b];}
}
let X=0;for(let i=0;i<T;i++){let a=Math.abs(l[i]);if(a>X)X=a;a=Math.abs(r[i]);if(a>X)X=a;}if(X>0){let scale=1/X;for(let i=0;i<T;i++){l[i]*=scale;r[i]*=scale;}}
let b=audiocontext.createBuffer(2,l.length,44100);b.getChannelData(0).set(l);b.getChannelData(1).set(r);
return b;
};

return {createbuffer};
}











function tutorial(){
let ci=0,p,song,clicks,S,P;let m=element("div",document.body,"tut-message");m.onclick=init;setTimeout(()=>m?.remove(),3000);initStyle();

function init(){m.remove();S=sequencer;P=piano;p=element("div",document.body,"tut-pointer");p.style.transition="transform .1s ease";initSong();initClicks();move();}
function move(){if(ci>=clicks.length)return p.remove();let e=clicks[ci++]();let r=e.getBoundingClientRect();p.style.top=r.top;p.style.left=r.left;click(e);}
function click(e){setTimeout(()=>{p.style.transform="scale(.5)";e.dispatchEvent(new MouseEvent("click",{bubbles:true}));setTimeout(()=>{p.style.transform="";setTimeout(move,100);},100);},100);}
function make(clickon,c,r){return ()=>clickon.cells.find(x=>x.row===r&&x.col===c);}
function toggle(c,r){return Array(2).fill(0).flatMap(()=>[make(S,c,-1),make(S,-1,r)]);}

function initClicks(){let notes=new Map();
let sequencerclicks=song.flatMap((t,c)=>t[0].flatMap((pid,r)=>(notes.set(c+"-"+pid,{c,r,a:t[1][pid-1]}),Array(pid).fill(0).map(()=>make(S,c,r)))));
let pianoclicks=[...notes.values()].flatMap(({c,r,a})=>toggle(c,r).toSpliced(2,0,...a.flatMap((n,r)=>n?[make(P,n-123,r)]:[])));
clicks=[...sequencerclicks,...pianoclicks,make(S,-1,-1)];
}

function initSong(){song=[
[[1,1,1,1],[[123,,,,123,,,,123,,,,123,,,,123,,,,123,,,,123,,,,123]]],
[[1,1,1,1],[[,,124,,,,,,,,,,,,124,,124]]],
[[1,1,2,3],[[135,,,,,,,,159,,157,,159,,,,,,,,,,,,147,154,,159],[138,,,,,,,,150,,159,,162,,,,,,,,,,150,,162,150,,159],[149,,,,,,,,149,,150,,154,,,,,,,,,,,,147,157,,159]]]];
}

function initStyle(){
element("style").textContent=""
+".tut-pointer,.tut-message{position:fixed;z-index:2;}"
+".tut-pointer::before{content:'ðŸ‘‰';}"
+".tut-message::before{content:'Click here to watch a 25 second tutorial';}"
+".tut-message{background:orange;color:black;padding:10;border-radius:5px;top:6dvh;border:2px outset orange;text-align:center;left:50%;transform:translateX(-50%);}"
;
}

}











}</script>
