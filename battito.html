<meta name="viewport" content="width=device-width"> <script> onload=()=>{let pl_synth_wasm_init=getPlayer();

document.title="Battito";
let tested="Requires Chrome browser";

applystyle();

let PLAYER=pl_synth_wasm_init;
let SR=500,SC=8,PR=32,PC=48;
let piano=element("div",document.body,"piano");
let sliders=element("div",document.body,"sliders");
let side=element("div",document.body,"side");
let sequencer=element("div",side,"sequencer");
let text=element("div",side,"text");
let canvas=element("canvas",side,"canvas");
text.contentEditable=true;
let fullscreenButton=element("div",document.body,"fullscreen");
fullscreenButton.textContent = "\u26F6";











function initPiano(){
grid(piano,PC,PR);
[...piano.children].forEach(cell => { let [r, c] = [parseInt(cell.dataset.row), parseInt(cell.dataset.col)]; if (c % 12 === 0) cell.style.borderLeft = "1px solid black"; if (r % 4 === 0) cell.style.borderTop = "1px solid black"; });
}

function initSliders(){
metaSliders().forEach((group,i)=>{
  group.forEach(([label,index,max])=>{
    let l=element("label",sliders);l.textContent=label;l.style.color=getColor(i);
    let s=element("input",sliders,"slider");s.type="range";s.dataset.index=index;s.max=max;s.disabled=true;
  });
});
}

function initSequencer() {
grid(sequencer, SC + 1, SR + 1, true);
for(let i=1;i<SC+1;i++){
  let cell=sequencer.children[i];
  cell.textContent = String.fromCharCode(65 + i-1);
  cell.style.color = getColor(i-1); 
}
for(let i=SC+1;i<(SC+1)*(SR+1);i+=SC+1){
  let cell=sequencer.children[i];
  cell.textContent = i/(SC+1);
}
}











function updatePiano(){
[...piano.children].forEach(cell=>{cell.style.background="";});
active.cols.forEach((isActive,i)=>{if(!isActive)return;
  let song = audio.getSong();
  song[1][i]?.[2]?.[song[1][i]?.[1]?.[audio.getcurr()]-1]?.forEach((col,row)=>{if(!col)return;
    piano.children[row*PC+col-123].style.background=getColor(i);
  });
});
}

function updateSliders(){
let ss=sliders.querySelectorAll(".slider"); let instrument=getActive("instrument");
if(instrument!==null){ ss.forEach(s=>{s.value=instrument[s.dataset.index];s.disabled=false;}); }
else{ ss.forEach(s=>{s.disabled=true;s.value=0;}); }
}

function updateSequencer(){
[...sequencer.children].forEach(cell=>{ cell.classList.remove("active","row-selected","col-selected");
  let {row,col}=cell.dataset; if(row==="-1"&&col==="-1"){return;}
  if(row==="-1"){ if(active.cols[col])cell.classList.add("col-selected"); }
  else if(col==="-1"){ if(active.rows[row])cell.classList.add("row-selected"); }
  else{ cell.textContent=""; let r=parseInt(row),c=parseInt(col); let song = audio.getSong(); if(song[1][c]&&song[1][c][1]?.[r]!==undefined){ if(active.rows[r]&&active.cols[c]){ cell.classList.add("active"); } cell.textContent=song[1][c][1][r]||""; } }
});
}

function updateText(){text.textContent=formatSongDataForDisplay(audio.getSong());}















let audio=(function(){

let SONG=presets();

let audioBuffer=null;
let A=null;
let playbackAnimationId=null;
let currSequence=null;
let prevSequence=null;
let audioContext=new AudioContext();
let bpm=samplesToBPM(SONG[0]);
function samplesToBPM(samplesPerStep,sampleRate=44100,stepsPerBeat=4){return (sampleRate*60)/(samplesPerStep*stepsPerBeat);}
function beatsToSeconds(beats,bpm){return (60/bpm)*beats;}

function stopPlayback(){
if(playbackAnimationId){cancelAnimationFrame(playbackAnimationId);playbackAnimationId=null;}
sequencer.querySelectorAll(".row-header").forEach(h=>h.classList.remove("row-playing"));
if(A){A.onended=null;A.stop();A.disconnect();A=null;}
}

function startPlayback(){
PLAYER(audioContext,synth=>{
  let activeSongParts=getActiveSongDataForPlayback();
  audioBuffer=synth.song(activeSongParts); A=audioContext.createBufferSource(); A.buffer=audioBuffer;
  A.connect(audioContext.destination); A.onended=()=>{startPlayback();};
  let startTime=audioContext.currentTime; A.start(startTime); A.startTime=startTime;
  playbackAnimationId=requestAnimationFrame(updatePlaybackPointers);
});
}

function updatePlaybackPointers(){
try{
if(!A||!audioBuffer)return;
let elapsed=(audioContext.currentTime-A.startTime)%audioBuffer.duration;
let activeSequences=active.rows.map((isOn,i)=>isOn?i:-1).filter(i=>i!==-1);
if(activeSequences.length===0)return;
let sequenceDuration=beatsToSeconds(PR/4,bpm);
let pianoRowDuration=sequenceDuration/PR;
if((elapsed/sequenceDuration)>activeSequences.length){
  if(playbackAnimationId)cancelAnimationFrame(playbackAnimationId);
  return;
}
currSequence=activeSequences[Math.floor(elapsed/sequenceDuration)%activeSequences.length];
let pianoRowIndex=Math.floor(elapsed/pianoRowDuration)%PR;
if(currSequence!==prevSequence){
  updateGridPointer(sequencer,SR+1,SC+1,currSequence,1);
  sequencer.children[currSequence*(SC+1)].scrollIntoView({block: "nearest"});
  prevSequence=currSequence;
  updatePiano();
}
updateGridPointer(piano,PR,PC,pianoRowIndex);
}catch(err){console.error("Playback pointer error:",err);
}finally{playbackAnimationId=requestAnimationFrame(updatePlaybackPointers);}
function updateGridPointer(grid,rows,cols,activeRow,offset=0){
  for(let r=0;r<rows;r++){
    grid.children[(r+offset)*cols]?.classList.toggle("row-playing",r===activeRow);
  }
}
}

function getcurr(){
return currSequence;
}

function setbpm(){
bpm=samplesToBPM(SONG[0]);
}

function getSong() {
  return SONG;
}

function setSong(newSong) {
  SONG = newSong;
}

return {getcurr,stopPlayback,startPlayback,audioContext,setbpm, getSong, setSong};

})();











function addEventListeners(){
sequencer.addEventListener("click",handleSequencerClick);
piano.addEventListener("click",e=>{handlePianoClick(e.target.dataset);});
text.addEventListener("paste",handleSongPaste);
text.addEventListener("input",handleSongInput);
sliders.addEventListener("input",e=>{let col=getActive("instrument"); if(col===null)return; if(!e.target.classList.contains("slider"))return; handleSliderInput(col,parseInt(e.target.dataset.index),parseInt(e.target.value));});
fullscreenButton.addEventListener("click", handleFullscreenToggle);
document.addEventListener("fullscreenchange",()=>{ if(!document.fullscreenElement){ fullscreenButton.style.display="block"; } });
makeLongPress(canvas,handleDownloadRequest);
}

function handlePianoClick({row,col}){
let p=getActive("pattern"); if(p==null)return;
let note=parseInt(col)+123;
if(p[row]==note){
  p[row]=0;
  update();
  return;
}
p[row]=note;
previewTrackSound(note);
update();
}

function handleSliderInput(instrument,setting,value){
instrument[setting]=value;
update();
previewTrackSound();
}

function handleSequencerClick(event){
let {row,col}=event.target.dataset;
if(row==="-1"&&col==="-1"){
  let allOn=active.cols.every(x=>x)&&active.rows.every(y=>y);
  let toggleValue=allOn?0:1;
  active.cols.fill(toggleValue);
  active.rows.fill(toggleValue);
}else if(row==="-1"){
  active.cols[col]=active.cols[col]?0:1;
  previewTrackSound();
}else if(col==="-1"){
  active.rows[row]=active.rows[row]?0:1;
}else{
  let r=parseInt(row),c=parseInt(col);
  let song = audio.getSong();
  if(!song[1][c])song[1][c]=[[],[],[]];
  if(!song[1][c][1])song[1][c][1]=[];
  let currentPatternId=song[1][c][1][r]??0;
  song[1][c][1][r]=(currentPatternId+1)%9;
}
update();
let isAnyTrackActive=active.cols.some(x=>x);
let isAnySequenceActive=active.rows.some(y=>y);
if(isAnyTrackActive&&isAnySequenceActive){audio.stopPlayback();audio.startPlayback();}else{audio.stopPlayback();}
}

function handleSongInput(){
if(text.textContent==""){
  resetActive();
  let s=[];
  s.push(5000);
  s.push([]);
  for(let i=0;i<8;i++){ 
    s[1].push([[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[],[]]); 
    s[1][i][0][0]=7;
    s[1][i][0][4]=255;
    s[1][i][0][13]=3000;
    s[1][i][0][16]=255;
  }
  text.textContent=formatSongDataForDisplay(s);
}
try{
audio.setSong(JSON.parse(text.textContent));
audio.setbpm();
update();
previewTrackSound();
}catch(e){}
}

function handleSongPaste(event){
event.preventDefault();
let pastedText=(event.clipboardData).getData("text");
let keepInstrumentsOnly=confirm("Delete song patterns and keep only the instruments?");
let newSongData;
try{
  let sanitizedJson=fillEmptyArrayValues(pastedText);
  newSongData=JSON.parse(sanitizedJson);
  while(newSongData[1].length<8){newSongData[1].push([[7,0,0,0,192,2,7,0,0,0,192,2,0,0,0,20000,192,0,0,0,0,121,0,0,0,0,0,0,0],[],[]]);}
  if(newSongData[1].length>8){newSongData[1].length=8;}
}catch(err){alert("Invalid JSON! Paste failed.");return;}
if(newSongData&&Array.isArray(newSongData[1])){
  newSongData[1].forEach(track=>{
    if(track&&Array.isArray(track[0])){
      while(track[0].length<29){
        track[0].push(0);
      }
    }
  });
}
if(keepInstrumentsOnly){newSongData=stripSongData(newSongData);}
let song = audio.getSong();
song[0]=newSongData[0];
song[1]=newSongData[1];
resetActive();
audio.setbpm();
update();
function stripSongData(songData){
let songCopy=JSON.parse(JSON.stringify(songData));
let instruments=songCopy[1].map(track=>[track[0],[],[]]);
return [songCopy[0],instruments];
}
}

function handleDownloadRequest() {
PLAYER(audio.audioContext,synth=>{try{
let b=synth.song(getActiveSongDataForPlayback());if(!b||b.length==0){return; }
let url=URL.createObjectURL(bufferToWav(b)); let a=element("a");a.href=url;a.download="battito_"+Date.now()+".wav"; a.click();URL.revokeObjectURL(a.href);a.remove();
}catch(e){}});
function bufferToWav(b){
 let c=b.numberOfChannels,l=b.length*c*2+44,o=new ArrayBuffer(l),v=new DataView(o),a=[],p=0,f=x=>{v.setUint16(p,x,1);p+=2;},F=x=>{v.setUint32(p,x,1);p+=4;};
 F(0x46464952);F(l-8);F(0x45564157);F(0x20746d66);F(16);f(1);f(c);F(b.sampleRate);F(b.sampleRate*c*2);f(c*2);f(16);F(0x61746164);F(l-p-4);
 for(let i=0;i<c;i++)a.push(b.getChannelData(i));
 for(let i=0,j=0;p<l;j++)for(i=0;i<c;i++){let s=a[i][j];s=s<-1?-1:s>1?1:s;s=(s<0?s*32768:s*32767)|0;v.setInt16(p,s,1);p+=2;}
 return new Blob([o],{type:'audio/wav'});
}
}

function handleFullscreenToggle() {
let el=document.documentElement;
if(el.requestFullscreen)el.requestFullscreen();
fullscreenButton.style.display="none";
}











function previewTrackSound(){
function drawWaveform(buffer,t){
let c=canvas.getContext("2d"),m=canvas.height/2;
c.fillStyle="#0A0F0A";c.fillRect(0,0,canvas.width,canvas.height);
if(!buffer||!t){ c.strokeStyle="#39FF14"; c.beginPath();c.moveTo(0,m);c.lineTo(canvas.width,m);c.stroke(); return; }
let d=buffer.getChannelData(0),p=d.length/canvas.width,v=t[16]/255,a=t[13]/p,s=t[14]/p,r=t[15]/p;
c.fillStyle="#003300";c.beginPath();c.moveTo(0,m);
[[a,m-(m*v)],[a+s,m-(m*v)],[a+s+r,m],[a+s,m+(m*v)],[a,m+(m*v)]].forEach(p=>c.lineTo(p[0],p[1]));
c.closePath();c.fill();c.beginPath();c.moveTo(0,m);
for(let x=0;x<canvas.width&&x*p<d.length;x++){c.lineTo(x,m+d[Math.floor(x*p)]*m);}
c.strokeStyle="#39FF14";
c.stroke();
}
let playing=null;
previewTrackSound=function(note){
if(playing){playing.stop();playing=null;}
let instrument=getActive("instrument");if(instrument==null)return;
PLAYER(audio.audioContext,synth=>{
let source=audio.audioContext.createBufferSource();
try{source.buffer=synth.sound(instrument,note);}catch(e){drawWaveform(null);return;}
source.connect(audio.audioContext.destination);
source.start();
playing=source;
source.onended=()=>{if(playing===source){playing=null;}};
let i=[...instrument];i[20]=i[21]=0;
drawWaveform(synth.sound(i),i);
});
};
return previewTrackSound();
}

function resetActive(){
for(let i=0;i<active.cols.length;i++){ active.cols[i]=0; }
for(let i=0;i<active.rows.length;i++){ active.rows[i]=0; }
}

function makeLongPress(o,callback){
let t=null,lp={
down(e){e.preventDefault();if(t!==null)clearTimeout(t);t=setTimeout(()=>{t=null;callback(e);},800);},
up(e){e.preventDefault();if(t!==null){clearTimeout(t);t=null;}}
};
o.addEventListener("pointerdown",lp.down); o.addEventListener("pointerup",lp.up); o.addEventListener("pointerleave",lp.up);
}

function formatSongDataForDisplay(songData) {
function stringify(arr) {return "[" + arr.map(x => Array.isArray(x) ? "\n" + stringify(x) : x || 0).join(",") + "]";}
return fillEmptyArrayValues(stringify(songData));
}

function fillEmptyArrayValues(s){
let prev;
do{prev=s;s=s.replace(/,\s*,/g,",0,").replace(/\[\s*,/g,"[0,").replace(/,\s*\]/g,",0]");}while(s!==prev);
return s;
}

let active=(function(){
let cols=Array(SC).fill(0);
let rows=Array(SR).fill(0);
return {cols,rows};
})();

function getActiveSongDataForPlayback(){
let songCopy=JSON.parse(JSON.stringify(audio.getSong()));
for(let t=songCopy[1].length-1;t>=0;t--){
  if(!active.cols[t]){
    songCopy[1].splice(t,1);
  }else{
    for(let s=songCopy[1][t][1].length-1;s>=0;s--){
      if(!active.rows[s]){
        songCopy[1][t][1].splice(s,1);
      }
    }
  }
}
return songCopy;
}

function grid(el, cols, rows, header) {
Object.assign(el.style, { gridTemplateColumns: "repeat(" + cols + ",1fr)", gridTemplateRows: "repeat(" + rows + ",1fr)" });
let totalCells = cols * rows;
for (let i = 0; i < totalCells; i++) {
  let c = i % cols; let r = Math.floor(i / cols); let a=0; let cellClasses = "cell";
  if (header === true) {a=-1; if (r === 0) { cellClasses += " col-header"; } if (c === 0) { cellClasses += " row-header"; } }
  let cell = element("div", el, cellClasses.trim());
  cell.dataset.row = r+a; cell.dataset.col = c+a;
}
}


function getActive(s){
let song = audio.getSong();
if(s=="track"){
  let activeIndices=active.cols.map((isActive,index)=>isActive?index:-1).filter(index=>index!==-1);
  return activeIndices.length===1?song[1][activeIndices[0]]||null:null;
}else if(s=="instrument"){
  return getActive("track")?.[0]||null;
}else if(s=="pattern"){
  if(active.cols.reduce((a,b)=>a+b,0)!==1||active.rows.reduce((a,b)=>a+b,0)!==1)return null;
  let c=active.cols.indexOf(1); 
  let r=song[1][c][1][active.rows.indexOf(1)]; if(!r)return null; r=r-1; 
  if(!song[1][c][2][r])song[1][c][2][r]=[];
  return song[1][c][2][r];
}
}

function element(tagName,parent=document.body,className=""){
let el=document.createElement(tagName);
if(className)el.className=className;
parent.appendChild(el);
return el;
}

function update(){
updatePiano();
updateSliders();
updateSequencer();
updateText();
}

function getColor(i){let hue=((i+5)*360)/9;return "hsl("+hue+", 70%, 50%)";}











function presets(){
return [5513,[
[[7,0,0,1,255,0,7,0,0,1,255,0,0,100,0,5970,171,2,500,254,1,31,4,21,0,0,0,0,0],[],[]],
[[7,0,0,0,255,2,7,0,4,0,255,2,0,88,2000,7505,255,2,3144,51,6,60,4,64,0,1,7,179,0],[],[]],
[[7,0,0,0,192,2,7,0,0,0,201,3,0,100,150,7505,191,2,5839,254,6,121,6,147,0,1,6,195,0],[],[]],
[[9,0,0,0,255,0,9,0,12,0,255,0,0,100,0,14545,70,0,0,240,2,157,3,47,0,0,0,0,0],[],[]],
[[7,0,0,0,255,3,8,0,0,0,255,0,127,22,22,2193,255,3,4067,176,4,12,2,84,0,1,3,96,0],[],[]],
[[7,0,0,0,255,2,7,0,9,0,154,2,0,2418,1075,10614,240,3,2962,255,6,117,3,73,0,1,5,124,0],[],[]],
[[7,0,0,0,192,3,7,0,7,0,201,3,0,789,1234,13636,191,2,5839,254,6,121,6,147,0,1,6,195,0],[],[]],
[[7,0,0,0,192,2,7,0,0,0,192,2,0,0,0,20000,192,0,0,0,0,121,0,0,0,0,0,0,0],[],[]],
]];
}

function metaSliders(){
return [
[["1v",4,255],["1w",5,3],["1o",0,16],["1s",1,11],["1d",2,255]],
[["2v",10,255],["2w",11,3],["2o",6,16],["2s",7,11],["2d",8,255]],
[["ea",13,200000],["es",14,200000],["er",15,200000],["e1",3,1],["e2",9,1]],
[["ct",17,4],["ca",18,11025],["cr",19,255]],
[["mw",28,3],["ms",26,16],["ma",27,255],["m1",24,1],["mc",25,1]],
[["ds",20,16],["da",21,248],["ps",22,16],["pa",23,255]],
[["nv",12,255],["vm",16,255]],
];
}

function applystyle(){
element("style").textContent=`
*{margin:0;padding:0;box-sizing:border-box;scrollbar-width:none;user-select: none;touch-action:manipulation;}
body { display: flex; background:black; color:white;font-weight: bold;font-family:monospace;}
.piano{background:white;}
.piano, .sequencer{ display:grid; }
.cell { display: flex; align-items: center; justify-content: center; border: 1px solid silver; aspect-ratio:1/1; }
.active { background: blue;}
.col-selected, .row-selected { background: gray; }
.row-playing { border-left: 3px solid orange !important; }
.sliders{ display: flex; flex-direction: column; justify-content: space-evenly;  font-size: 8px; }
.sliders > * { display: flex; flex-direction: column; align-items: center; }
.sliders .slider { height: 2px; }
.sliders input[type="range"]::-webkit-slider-thumb { opacity: 0; }
.text{ padding: 10px; font-size: 5px; white-space: pre; overflow: auto; }
.sequencer { height:50dvh; aspect-ratio:1/1; overflow-y: scroll; }
.text{ height:25dvh; aspect-ratio:2/1; }
.canvas{ height:25dvh; aspect-ratio:2/1; }
.fullscreen{position:fixed;bottom:5px;right:5px;color:orange;z-index:1000;font-size:20px;}
.text, .canvas {border:1px solid silver; border-top:none;}
}
`;
}


function main(){
if (!window.chrome) {
  document.body.innerHTML = "";
  document.body.style.cssText = " background: black; color: white; font-family: monospace; display: flex; justify-content: center; align-items: center; height: 100vh; padding: 3em; text-align: center; ";
  document.body.textContent = tested;
  return;
}
initPiano();
initSliders();
initSequencer();
update();
previewTrackSound(0);
addEventListeners();
runTutorial();
}

main();











function runTutorial(){
applystyle();
let p=element("div",document.body,"tutorial-pointer");
let m=element("div",document.body,"tutorial-message");
let s=element("div",document.body,"tutorial-skip");
s.textContent="Skip Tutorial";
let cs=-1;let ta=true;
function cl(){if(!ta)return;ta=false;p.remove();m.remove();s.remove();}
s.addEventListener("click",cl);

function gtfs(song){
let st=[];let ptd={};
song[1].forEach((track,ti)=>{
  if(track&&track[1]){
    track[1].forEach((pi,ri)=>{
      if(pi>0){
        for(let i=0;i<pi;i++){st.push({target:()=>sequencer.querySelector('[data-col="' + ti + '"][data-row="' + ri + '"]'),action:'click'});}
        let k=ti+"-"+pi;
        if(!ptd[k]&&track[2]&&track[2][pi-1]){ptd[k]={ti,pi,dr:ri};}
      }
    });
  }
});

for(let k in ptd){
  let {ti,pi,dr}=ptd[k];
  let pd=song[1][ti][2][pi-1];
  st.push({target:()=>sequencer.querySelector('[data-col="' + ti + '"][data-row="-1"]'),action:'click'});
  st.push({target:()=>sequencer.querySelector('[data-col="-1"][data-row="' + dr + '"]'),action:'click'});
  if(pd){pd.forEach((note,pr)=>{if(note>0){let pc=note-123;st.push({target:()=>piano.querySelector('[data-col="' + pc + '"][data-row="' + pr + '"]'),action:'click'});}});}
  st.push({target:()=>sequencer.querySelector('[data-col="-1"][data-row="' + dr + '"]'),action:'click'});
  st.push({target:()=>sequencer.querySelector('[data-col="' + ti + '"][data-row="-1"]'),action:'click'});
}
st.push({target:()=>sequencer.querySelector('[data-col="-1"][data-row="-1"]'),action:'click'});
return st;
}

function loop(){
if(!ta)return;cs++;if(cs>=ss.length){cl();return;}let s=ss[cs];
m.textContent=s.msg||"";if(s.msg)m.style.display='block';else m.style.display='none';
let pa=(te)=>{
  let r=te.getBoundingClientRect();p.style.top=r.top+r.height/2+"px";p.style.left=r.left+r.width/2+"px";
  setTimeout(()=>{
    if(!ta)return;
    let cap=(delay=100)=>{
      p.classList.add('clicking');
      setTimeout(()=>{
        te.dispatchEvent(new MouseEvent('click',{bubbles:true,cancelable:true}));
        p.classList.remove('clicking');
        setTimeout(loop,delay/2);
      },100);
    };
    if(s.action==='click'){cap();}
  },200);
};
if(s.target){let te=s.target();if(te){pa(te);}else{setTimeout(loop,100);}}
else if(s.wait){setTimeout(loop,s.wait);}
}

let ts=[5088,[[[7,0,0,1,255,0,7,0,0,1,255,0,0,100,0,5970,171,2,500,254,1,31,4,21],[1,1,1,1],[[147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147,0,0,0,147]]],[[7,0,0,0,255,2,7,0,4,0,255,2,0,88,2000,7505,255,2,3144,51,6,60,4,64,0,1,7,179],[1,1,1,1],[[0,0,123,0,0,0,0,0,0,0,0,0,0,0,123,0,123]]],[[7,0,0,0,192,2,7,0,0,0,201,3,0,100,150,7505,191,2,5839,254,6,121,6,147,0,1,6,195],[1,1,2,3],[[135,0,0,0,0,0,0,0,159,0,157,0,159,0,0,0,0,0,0,0,0,0,0,0,147,154,0,159],[138,0,0,0,0,0,0,0,150,0,159,0,162,0,0,0,0,0,0,0,0,0,150,0,162,150,0,159],[149,0,0,0,0,0,0,0,149,0,150,0,154,0,0,0,0,0,0,0,0,0,0,0,147,157,0,159]]]]];

let ss=[
  {msg:"Welcome to Battito! Watch how this song is made.",wait:300},
  {msg:"Click here to enable audio.",wait:500},
    ...gtfs(ts),
  {msg:"See the README for help \uD83D\uDC8B",wait:9000},
];

element("style").textContent = " .tutorial-pointer { position: fixed; width: 30px; height: 30px; z-index: 10001; transform: translate(-100%, -30%); transition: all 0.3s ease-in-out; pointer-events: none; filter: drop-shadow(0 0 5px orange); } .tutorial-pointer::before { content: \x22\\1F449\x22; font-size: 30px; position: absolute; top: 0; left: 0; line-height: 1; } .tutorial-pointer.clicking { transform: translate(-100%, -30%) scale(0.9); transition: all 0.1s ease-in-out; } .tutorial-message { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(255, 165, 0, 0.9); color: black; padding: 10px 20px; border-radius: 5px; font-family: monospace; font-size: 16px; z-index: 10002; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); max-width: 90%; } .tutorial-skip { position: fixed; top: 15px; right: 15px; background: gray; color: white; padding: 5px 10px; border-radius: 3px; cursor: pointer; z-index: 10003; font-size: 14px; } ";

loop();
}










function getPlayer(){
//https://github.com/phoboslab/pl_synth
let pl_synth_wasm_init=(A,g)=>{let I=null,C=0,t=A=>{let g=C+2*A*4,t=Math.ceil(g/65536),e=Math.ceil(I.memory.buffer.byteLength/65536);return t>e&&I.memory.grow(t-e),[new Float32Array(I.memory.buffer,C,A),new Float32Array(I.memory.buffer,C+4*A,A)]},e=A=>{for(let g=0;g<A.length;g++)A[g]=Array.isArray(A[g])?e(A[g]):A[g]??0;return A},Q=(A,g)=>{let I=A[20]*g>>1,C=A[21]/255,t=Math.ceil(Math.log(.1)/Math.log(C));return A[13]+A[14]+A[15]+t*I},E=(A,g,C,t)=>{let e=t[20]*C>>1,Q=t[21]/255;Q&&I.delay(A.byteOffset,g.byteOffset,A.length,e,Q)},f=(g,C=147,f=5513)=>{g=e(g);let B=Q(g,f),i=A.createBuffer(2,B,44100),l=i.getChannelData(0),a=i.getChannelData(1),[h,s]=t(B);return I.clear(h.byteOffset,h.length),I.clear(s.byteOffset,s.length),I.gen(h.byteOffset,s.byteOffset,0,f,C,...g),E(h,s,f,g),l.set(h),a.set(s),i},B=g=>{let C=(g=e(g))[0],f=g[1],B=0;for(let A of f){let g=A[1].length*C*32+Q(A[0],C);g>B&&(B=g)}let i=A.createBuffer(2,B,44100),l=i.getChannelData(0),a=i.getChannelData(1),[h,s]=t(B);for(let A of f){let g=A[0],t=A[1],e=0,Q=B;I.clear(h.byteOffset,h.length),I.clear(s.byteOffset,s.length);for(let E of t)for(let t=0;t<32;t++){let f=A[2][E-1]?.[t];f&&(Q=Math.min(Q,e),I.gen(h.byteOffset,s.byteOffset,e,C,f,...g)),e+=C}E(h,s,C,g);for(let A=Q;A<B;A++)l[A]+=h[A],a[A]+=s[A]}return i},i=atob("AGFzbQEAAAABQQZgAX0BfWACfX0BfWAAAGAif39/f39/f39/f39/f39/f39/f39/f39/f39/f39/f39/fwBgAn9/AGAFf39/f30AAhUCA2VudgNzaW4AAANlbnYDcG93AAEDBgUCAgMEBQUDAQADBiwHfwFBkIgIC38AQYAIC38AQZCIBAt/AEGACAt/AEGQiAgLfwBBAAt/AEEBCweUAQwGbWVtb3J5AgARX193YXNtX2NhbGxfY3RvcnMAAgRpbml0AAMDZ2VuAAQFY2xlYXIABQVkZWxheQAGDF9fZHNvX2hhbmRsZQMBCl9fZGF0YV9lbmQDAg1fX2dsb2JhbF9iYXNlAwMLX19oZWFwX2Jhc2UDBA1fX21lbW9yeV9iYXNlAwUMX190YWJsZV9iYXNlAwYKiwwFAgAL1AEFAX8BfAF/An0BfEEAIQBEAAAAAAAAAAAhAUGAgH8hAgNAIACyIgND2A/JOpQQgICAgAAhBCACQZCIg4AAaiADQwAAgDmUQwAAAL+SOAIAIAJBkIiBgABqIAQ4AgAgAkGQiISAAGogAUQAAAAAAABQP6IiBUQAAAAAAADwv6BEAAAAAAAACEAgBaEgAEGAEEkbtjgCACACQZCIgoAAakMAAIC/QwAAgD8gBEMAAAAAXRs4AgAgAEEBaiEAIAFEAAAAAAAA8D+gIQEgAkEEaiICDQALC68JBgF/En0CfAJ9AXwBfSOAgICAAEEgayIiJICAgIAAQwAAAEAgG0F4arIQgYCAgAAhI0MAAABAIB9BeGqyEIGAgIAAISRDfZyHPyAFQQxsIARBoH5qIhtqIAZqshCBgICAACElQ32chz8gC0EMbCAbaiAMarIQgYCAgAAhJgJAIBMgEmoiCyAUakF/akEASA0AICW7RAAAAAAAAHA/oiAHs0MXt1E6lEMAAIA/kruitiEnICa7RAAAAAAAAHA/oiANs0MXt1E6lEMAAIA/kruitiEoIByzQwAAADuUISkgILNDAAAAO5QhKkMAAIA/IBSzlSErQwAAgD8gErOVISwgEbNDAAAAMJQhLSAYs0MAAH9DlSEuICMgA7IiJZUhLyAkICWVITAgFEF/aiEMIAsgAmohHyAVs0PG+Rs7lCExIAEgFCATaiASaiACakECdEF8aiITaiEUIAAgE2ohEyAiQQxqIBZBAnRqIQAgD7MhMiAJsyEzIBezITRBACgCgIiAgAAhAkQAAAAAAAAAACE1ICFBDnQhBiAKQQ50IQUgEEEOdCEERAAAAAAAAAAAITZDAAAAACEmQwAAAAAhNwNAAkACQCAwIB8gDGqyIjiUQwAAgEWUIiOLQwAAAE9dRQ0AICOoIRsMAQtBgICAgHghGwsgBiAbQf8fcUECdHJBkIiAgABqKgIAICqUQwAAAD+SISUCQAJAIAsgDGoiGyASTw0AICwgG7KUISMMAQtDAACAPyEjIBsgC0kNAEMAAIA/IAyzICuUkyEjCwJAAkAgNSAlQwAAgD8gHRsgJ5QgIyAjlCIkQwAAgD8gCBuUu6AiNUQAAAAAAACwQKIiOZlEAAAAAAAA4EFjRQ0AIDmqIRsMAQtBgICAgHghGwsgBSAbQf8fcUECdHJBkIiAgABqKgIAIDOUQwAAAACSIToCQAJAIDYgJEMAAIA/IA4bICiUu6AiNkQAAAAAAACwQKIiOZlEAAAAAAAA4EFjRQ0AIDmqIRsMAQtBgICAgHghGwsgBCAbQf8fcUECdHJBkIiAgABqKgIAIDKUIDqSISQCQCAtQwAAAABbDQBBACACQQ10IAJzIhtBEXYgG3MiG0EFdCAbcyIbNgKAiICAACAtIAKylCAjlCAkkiEkIBshAgsgI0OBgIA7lCAklCEjAkAgFkUNAAJAAkAgJUMAAIA/IB4bIDSUQ8Y3PjeUQwAAgEWUIiSLQwAAAE9dRQ0AICSoIRsMAQtBgICAgHghGwsgIiAbQf8fcUECdEGQiICAAGoqAgBDAADAP5QiJCA3lCAmkiImOAIUICIgIzgCDCAiIC4gIyA3k5QgJpMiIzgCECAiICYgI5I4AhwgIiAkICOUIDeSIjc4AhggACoCACEjCyAxICOUISMCQAJAIC8gOJRDAACARZQiJItDAAAAT11FDQAgJKghGwwBC0GAgICAeCEbCyATICNDAACAPyAbQf8fcUECdEGQiICAAGoqAgAgKZRDAAAAP5IiJJOUIBMqAgCSOAIAIBQgIyAklCAUKgIAkjgCACAUQXxqIRQgE0F8aiETIAsgDEF/aiIMakF/Sg0ACwsgIkEgaiSAgICAAAsYAAJAIAFBAUgNACAAQQAgAUECdPwLAAsLZgEBfwJAIAIgA0wNACADQQJ0IQUgAiADayEDA0AgACAFaiICIAEqAgAgBJQgAioCAJI4AgAgASAFaiICIAAqAgAgBJQgAioCAJI4AgAgAEEEaiEAIAFBBGohASADQX9qIgMNAAsLCwsLAQBBgAgLBKVU9dgAZARuYW1lAT8HAAdqc19zaW5mAQdqc19wb3dmAhFfX3dhc21fY2FsbF9jdG9ycwMEaW5pdAQDZ2VuBQVjbGVhcgYFZGVsYXkHEgEAD19fc3RhY2tfcG9pbnRlcgkIAQAFLmRhdGEAOAlwcm9kdWNlcnMBDHByb2Nlc3NlZC1ieQEMVWJ1bnR1IGNsYW5nETE0LjAuMC0xdWJ1bnR1MS4xAB4PdGFyZ2V0X2ZlYXR1cmVzASsLYnVsay1tZW1vcnk="),l=new Uint8Array(i.length);for(let A=0;A<i.length;A++)l[A]=i.charCodeAt(A);WebAssembly.instantiate(l,{env:{pow:Math.pow,sin:Math.sin}}).then((A=>{I=A.instance.exports,I.init(),C=I.memory.buffer.byteLength,g&&g({sound:f,song:B})}))};
return pl_synth_wasm_init;
}

} </script>

